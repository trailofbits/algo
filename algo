#!/usr/bin/env bash

set -e

# Check if uv is installed, if not, install it automatically
if ! command -v uv &> /dev/null; then
    echo "Installing uv (fast Python package manager)..."
    if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" ]]; then
        # Windows (Git Bash/WSL)
        powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"
    else
        # macOS/Linux
        curl -LsSf https://astral.sh/uv/install.sh | sh
    fi
    
    # Reload PATH to find uv
    export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
    
    # Verify installation worked
    if ! command -v uv &> /dev/null; then
        echo "Error: uv installation failed. Please restart your terminal and try again."
        exit 1
    fi
    
    echo "âœ“ uv installed successfully!"
fi

# Run the appropriate playbook
case "$1" in
  update-users) 
    uv run ansible-playbook users.yml "${@:2}" -t update-users ;;
  *) 
    uv run ansible-playbook main.yml "${@}" ;;
esac
